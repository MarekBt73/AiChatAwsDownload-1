{% extends "base_generic.html" %} 
{% load static %} 

{% block title %} 
Chat with GPT 
{% endblock %} 

{% block styles %}
<style>
  body, html {
    height: 100%;
  }
  .messages-box {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .message-content {
    white-space: pre-wrap; /* Umożliwia zawijanie wierszy */
    line-height: 1.2; /* Zmniejsza interlinię */
    word-break: break-word; /* Zapewnia łamanie słów */
  }
</style>
{% endblock %}

{% block content %}
<div class="chat-container flex flex-col h-90 pb-64">
  <div class="card flex-grow flex flex-col">
    <div class="card-header bg-green-500 text-white p-4">Korepetycja z Matematyki klas 2 liceum / technikum</div>
    {% if user.is_authenticated %}
    <div class="bg-green-500  text-white p-4"><h3 class="text-base/7 text-xl"  >Witaj, {{user.username}}</h3></div>
    {% endif %}
    <div class="card-body messages-box flex-grow overflow-y-auto p-4 bg-gray-100">
      <ul class="messages-list space-y-4">
        {% for chat in chats %}
          {% if chat.user == request.user %}
            <li class="message sent flex flex-col items-start">
              <div class="message-text p-3 bg-green-100 rounded-lg">
                <div class="message-sender font-bold">
                  You
                </div>
                <div class="message-content">
                  {{chat.message}}
                </div>
              </div>
            </li>
            <li class="message received flex flex-col items-start">
              <div class="message-text p-3 bg-gray-200 rounded-lg">
                <div class="message-sender font-bold">
                  AI-Mentor
                </div>
                <div class="message-content">
                  {{chat.response}}
                </div>
              </div>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  </div>
  <form class="message-form flex items-center justify-center p-4 bg-gray-200 fixed bottom-0 left-0 right-0">
    {% csrf_token %}
    <div class=" flex justify-center  lg:w-[100%]  xl:w-[80%]  lg:px-24  mb-36 ">
      <input type="text" class=" message-input flex-grow p-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring focus:border-blue-300" placeholder="Type your message...">
      <button type="submit" class="btn-send bg-blue-500 text-white p-2 rounded-r-md hover:bg-blue-700">Wyślij</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const messagesList = document.querySelector('.messages-list');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');

    function appendMessage(message, sender) {
      const messageItem = document.createElement('li');
      messageItem.classList.add('message', sender, 'flex', 'flex-col', 'items-start');
      messageItem.innerHTML = `
        <div class="message-text p-3 ${sender === 'sent' ? 'bg-green-100' : 'bg-gray-200'} rounded-lg">
            <div class="message-sender font-bold">
                ${sender === 'sent' ? 'You' : 'AI Chatbot'}
            </div>
            <div class="message-content">
                ${message}
            </div>
        </div>`;
      messagesList.appendChild(messageItem);
      messageItem.scrollIntoView({ behavior: "smooth" });
    }

    messageForm.addEventListener('submit', (event) => {
      event.preventDefault();

      const message = messageInput.value.trim();
      if (message.length === 0) {
        return;
      }

      appendMessage(message, 'sent');
      messageInput.value = '';

      fetch('', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'message': message
        })
      })
      .then(response => response.json())
      .then(data => {
        appendMessage(data.response, 'received');
      });
    });
  });
</script>
{% endblock %}
